# Caddy SSL Certificates

This directory contains SSL/TLS certificates for Caddy reverse proxy.

## Cloudflare Origin CA Certificate (Production)

For production deployment with Cloudflare proxy, you need to generate and install a Cloudflare Origin CA certificate.

### Why Origin CA?

When using Cloudflare's proxy (orange cloud), the connection flow is:
```
Client <HTTPS> Cloudflare <HTTPS> Caddy <HTTP> Relay
```

Cloudflare requires your origin server (Caddy) to have a valid SSL certificate. Origin CA certificates are:
- ✅ Free and valid for 15 years
- ✅ Trusted by Cloudflare
- ✅ Support wildcard domains (`*.noverlink.com`)
- ⚠️ **NOT trusted by browsers** (only use with Cloudflare proxy enabled)

### Setup Instructions

#### 1. Generate Origin CA Certificate

1. Log in to [Cloudflare Dashboard](https://dash.cloudflare.com)
2. Select your domain (e.g., `noverlink.com`)
3. Navigate to **SSL/TLS** → **Origin Server**
4. Click **Create Certificate**
5. Configure certificate:
   - **Private key type**: RSA (2048)
   - **Hostnames**:
     ```
     *.noverlink.com
     noverlink.com
     ```
   - **Certificate Validity**: 15 years (maximum)
6. Click **Create**

#### 2. Download and Install

1. **Download files**:
   - **Origin Certificate** → Save as `origin.pem`
   - **Private Key** → Save as `origin.key`

2. **Copy to this directory**:
   ```bash
   # From your local machine
   scp origin.pem origin.key user@server:/path/to/noverlink/deploy/caddy/certs/
   ```

3. **Set proper permissions** (on server):
   ```bash
   cd /path/to/noverlink/deploy/caddy/certs
   chmod 600 origin.key  # Private key: owner read/write only
   chmod 644 origin.pem  # Certificate: public readable
   ```

#### 3. Configure Cloudflare SSL/TLS Mode

1. In Cloudflare Dashboard, go to **SSL/TLS** → **Overview**
2. Select **Full (strict)** mode
3. This ensures Cloudflare validates your Origin CA certificate

### File Structure

```
deploy/caddy/certs/
├── .gitignore       ✅ Committed (protects sensitive files)
├── README.md        ✅ Committed (this file)
├── origin.pem       ❌ NOT committed (server-specific, generated by you)
└── origin.key       ❌ NOT committed (SENSITIVE! Never commit!)
```

### Security Notes

⚠️ **CRITICAL**: Never commit `origin.pem` or `origin.key` to git!

- The `.gitignore` file in this directory prevents accidental commits
- These files contain cryptographic keys specific to your server
- If leaked, attackers could impersonate your origin server
- Each environment (staging, production) should have separate certificates

### Troubleshooting

#### Certificate not found error
```
Error: failed to load certificate: no such file or directory
```
**Solution**: Ensure `origin.pem` and `origin.key` exist in this directory.

#### Permission denied error
```
Error: permission denied reading origin.key
```
**Solution**:
```bash
chmod 600 origin.key
chown caddy:caddy origin.key  # If running Caddy as non-root
```

#### SSL handshake failed (Cloudflare → Origin)
**Possible causes**:
1. Cloudflare SSL/TLS mode is not set to **Full (strict)**
2. Certificate hostname mismatch
3. Certificate expired (unlikely with 15-year validity)

**Solution**: Verify Cloudflare SSL/TLS settings and certificate hostnames.

### Alternative: Let's Encrypt (Development)

For development or when **NOT** using Cloudflare proxy:
- Caddy can automatically obtain Let's Encrypt certificates
- No manual certificate management needed
- See `Caddyfile.dev` for development configuration

### References

- [Cloudflare Origin CA Documentation](https://developers.cloudflare.com/ssl/origin-configuration/origin-ca/)
- [Caddy TLS Documentation](https://caddyserver.com/docs/caddyfile/directives/tls)
